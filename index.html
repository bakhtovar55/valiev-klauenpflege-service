<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
    <title>Valiev Klauenpflege Service ‚Äì App</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- –í–ê–ñ–ù–û: –ø–æ–¥–∫–ª—é—á–∞–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#047857">

    <style>
        /* ---------- –û–ë–©–ò–ô –î–ò–ó–ê–ô–ù –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---------- */

        body {
            font-family: Arial, sans-serif;
            background: #f3f4f6;
            margin: 0;
            padding: 0;
        }
        header {
            background: #047857;
            color: white;
            padding: 10px 16px;
            text-align: center;
        }
        header h1 {
            margin: 4px 0;
            font-size: 20px;
        }
        header p {
            margin: 0;
            font-size: 12px;
            opacity: 0.9;
        }
        .header-sub {
            font-size: 11px;
            opacity: 0.85;
        }
        #connectionStatus {
            font-size: 12px;
            font-weight: 600;
        }

        main {
            max-width: 900px;
            margin: 12px auto 40px;
            padding: 0 10px;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.06);
        }
        .card h2 {
            margin-top: 0;
            font-size: 16px;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 6px;
        }
        label {
            display: block;
            font-size: 13px;
            margin-top: 6px;
        }
        input, select, textarea {
            width: 100%;
            box-sizing: border-box;
            padding: 6px 8px;
            margin-top: 2px;
            border-radius: 4px;
            border: 1px solid #d1d5db;
            font-size: 13px;
        }
        textarea {
            min-height: 60px;
            resize: vertical;
        }
        button {
            margin-top: 10px;
            padding: 8px 14px;
            border-radius: 6px;
            border: none;
            background: #047857;
            color: white;
            font-size: 13px;
            cursor: pointer;
        }
        button.secondary {
            background: #374151;
        }
        button.danger {
            background: #b91c1c;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .row {
            display: flex;
            gap: 8px;
        }
        .row > div {
            flex: 1;
        }
        .info {
            font-size: 12px;
            color: #6b7280;
        }
        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 999px;
            font-size: 11px;
            background: #e5e7eb;
            margin-right: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 6px;
            font-size: 12px;
        }
        th, td {
            border: 1px solid #e5e7eb;
            padding: 4px 6px;
            text-align: left;
        }
        th {
            background: #f9fafb;
        }
        .msg {
            font-size: 13px;
            margin-top: 6px;
        }
        .msg.ok {
            color: #047857;
        }
        .msg.err {
            color: #b91c1c;
        }
        @media (max-width: 600px) {
            .row {
                flex-direction: column;
            }
        }
/* ---- –î–ò–ó–ê–ô–ù TAGESBERICHT / PDF (—ç–∫—Ä–∞–Ω + –ø–µ—á–∞—Ç—å) --------- */

#reportArea {
    margin-top: 12px;
}

/* —Ä–∞–º–∫–∞ –≤–æ–∫—Ä—É–≥ –æ—Ç—á—ë—Ç–∞ */
.report-container {
    border: 1px solid #d1d5db;
    border-radius: 8px;
    padding: 12px 14px;
    background: #ffffff;
}
/* –∑–µ–ª—ë–Ω–∞—è –ª–∏–Ω–∏—è –ø–æ–¥ —à–∞–ø–∫–æ–π –æ—Ç—á—ë—Ç–∞ ‚Äì –Ω–∞ —ç–∫—Ä–∞–Ω–µ –∑–µ–ª—ë–Ω–∞—è */
.report-header-line {
    width: 100%;
    height: 0;
    border-top: 3px solid #047857;   /* –∑–µ–ª—ë–Ω—ã–π –Ω–∞ —ç–∫—Ä–∞–Ω–µ */
    margin: 6px 0 10px;
}

/* –ø—Ä–∏ –ø–µ—á–∞—Ç–∏ ‚Äì –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —á—ë—Ä–Ω–∞—è –ª–∏–Ω–∏—è, —á—Ç–æ–±—ã –µ—ë –±—ã–ª–æ –≤–∏–¥–Ω–æ */
@media print {
    .report-header-line {
        border-top: 2px solid #047857 !important;
    }
}
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 12px 14px;
            background: #ffffff;
            font-size: 12px;
        }

        .report-header {
            margin-bottom: 6px;
        }

        .report-title-row {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 8px;
        }

        .report-header-icon {
            font-size: 18px;
            margin-right: 4px;
        }

        .report-title-main {
            font-size: 16px;
            font-weight: 700;
            color: #047857;
        }

        .report-title-date {
            font-size: 12px;
            color: #6b7280;
        }

        .report-subtitle {
            font-size: 11px;
            color: #6b7280;
        }

        .report-divider {
            margin: 6px 0 8px;
            height: 2px;
            background: #047857;  /* –∑–µ–ª—ë–Ω–∞—è –ø–æ–ª–æ—Å–∞ –ø–æ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º */
            border-radius: 2px;
        }

        .report-meta {
            font-size: 11px;
            margin-bottom: 6px;
        }
        .report-meta span {
            display: inline-block;
            margin-right: 18px;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 4px;
            font-size: 12px;
        }
        .report-table th,
        .report-table td {
            border: 1px solid #e5e7eb;
            padding: 4px 6px;
            text-align: left;
        }
        .report-table th {
            background: #f3f4f6;
        }
        .report-table tbody tr:nth-child(even) {
            background: #f9fafb;
        }
        .report-table th:nth-child(3),
        .report-table th:nth-child(6),
        .report-table th:nth-child(7),
        .report-table td:nth-child(3),
        .report-table td:nth-child(6),
        .report-table td:nth-child(7) {
            text-align: center;
        }

        .report-footer {
            margin-top: 10px;
            font-size: 11px;
            color: #4b5563;
        }

        /* ---------- –ü–ï–ß–ê–¢–¨ (PDF) ---------- */
        @media print {
            body {
                background: #ffffff;
            }
            header {
                margin-bottom: 10px;
            }
            /* —Å–∫—Ä—ã–≤–∞–µ–º –æ–±—ã—á–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –æ—Ç—á—ë—Ç */
            section.card {
                display: none;
            }
            section.card#reportCard {
                display: block;
                box-shadow: none;
                border-radius: 0;
                margin: 0;
            }
            .report-table {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>

<header>
    <h1>üêÑ Valiev Klauenpflege Service</h1>
    <p id="connectionStatus">Status wird geladen‚Ä¶</p>
    <p class="header-sub">
        Digitale Klauenpflege-Dokumentation & transparente Behandlungsberichte f√ºr landwirtschaftliche Betriebe und Milchviehhalter
    </p>
    <p class="header-sub">
        Digitale Klauenpflege-Software f√ºr Dokumentation, Kontrolle und Auswertung
    </p>
</header>

<main>

    <!-- 1. KUH HINZUF√úGEN / BEARBEITEN -->
    <section class="card">
        <h2>1. Kuh hinzuf√ºgen / bearbeiten</h2>
        <div class="row">
            <div>
                <label>Kuh Nummer</label>
                <input id="cowNumber" placeholder="z.B. 245">
            </div>
            <div>
                <label>Hof / Betrieb</label>
                <input id="farmName" placeholder="z.B. Hof M√ºller">
            </div>
        </div>
        <div class="row">
            <div>
                <label>Geburtsdatum</label>
                <input id="birthDate" placeholder="z.B. 12.02.2022">
            </div>
            <div>
                <label>Aktuell lahm?</label>
                <select id="lameStatus">
                    <option value="">Nein / unbekannt</option>
                    <option value="lahm rechts">Lahm rechts</option>
                    <option value="lahm links">Lahm links</option>
                    <option value="beide Hinterklauen">Beide Hinterklauen</option>
                </select>
            </div>
        </div>
        <label>Notizen zur Kuh</label>
        <textarea id="cowNotes" placeholder="z.B. Problem mit Mortellaro, sensibel beim Beschneiden"></textarea>

        <button onclick="saveCow()">üíæ Kuh speichern</button>
        <div id="cowMessage" class="msg"></div>
        <div class="info">
            Tipp: gleiche Nummer noch einmal speichern ‚Äì Kuh wird aktualisiert (Hof, Notizen usw.).
        </div>
    </section>

    <!-- 2. BEHANDLUNG EINTRAGEN -->
    <section class="card">
        <h2>2. Behandlung eintragen</h2>
        <label>Kuh Nummer ausw√§hlen</label>
        <select id="treatCowSelect">
            <option value="">-- erst Kuh speichern --</option>
        </select>

        <div class="row">
            <div>
                <label>Datum der Behandlung</label>
                <input id="treatDate" placeholder="TT.MM.JJJJ">
            </div>
            <div>
                <label>Klauen-Seite</label>
                <select id="treatLeg">
                    <option value="VL">VL (Vorne links)</option>
                    <option value="VR">VR (Vorne rechts)</option>
                    <option value="HL">HL (Hinten links)</option>
                    <option value="HR">HR (Hinten rechts)</option>
                </select>
            </div>
        </div>

       <label for="treatProblem">Problem / Diagnose</label>

<!-- –ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞ -->
<select id="treatProblem" onchange="setActionsByProblem()">
    <option value="">‚Äì Krankheit ausw√§hlen ‚Äì</option>

    <!-- Standart-Probleme -->
    <option value="Mortellaro (Dermatitis digitalis)">Mortellaro (Dermatitis digitalis)</option>
    <option value="Sohlengeschw√ºr">Sohlengeschw√ºr</option>
    <option value="Wei√üe-Linie-Defekt">Wei√üe-Linie-Defekt</option>
    <option value="Ballengeschw√ºr">Ballengeschw√ºr</option>
    <option value="Klauenf√§ule">Klauenf√§ule</option>
    <option value="Zwischenklauenentz√ºndung (Phlegmone)">Zwischenklauenentz√ºndung (Phlegmone)</option>
    <option value="Hornspalt / Riss">Hornspalt / Riss</option>
    <option value="√úberwuchs / Fehlstellung">√úberwuchs / Fehlstellung</option>
    <option value="Trauma / mechanische Verletzung">Trauma / mechanische Verletzung</option>

    <!-- Deine gew√ºnschten Zusatz-Probleme -->
    <option value="Limax (doppelte Sohle)">Limax (doppelte Sohle)</option>
    <option value="Allgemeine Entz√ºndung / Schwellung">Allgemeine Entz√ºndung / Schwellung</option>
    <option value="Panaritium (tiefe Klauenentz√ºndung)">Panaritium (tiefe Klauenentz√ºndung)</option>
</select>
<!-- –ü–æ–ª–µ, –∫–æ—Ç–æ—Ä–æ–µ —Ä–µ–∞–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –±–∞–∑–µ (–Ω–∏—á–µ–≥–æ –º–µ–Ω—è—Ç—å –≤ JS –Ω–µ –Ω—É–∂–Ω–æ) -->
<textarea id="treatProblem" placeholder="Problem / Diagnose eingeben‚Ä¶"></textarea>
  <label>Ma√ünahmen (Was wurde gemacht?)</label>

<select id="treatActionsPreset" onchange="applyActionsPreset()" style="margin-bottom:6px;">
    <option value="">‚Äì Ma√ünahme ausw√§hlen ‚Äì</option>

    <!-- Allgemein -->
    <option value="Funktioneller Klauenschnitt">
        Funktioneller Klauenschnitt
    </option>
    <option value="√úberwuchs korrigiert">
        √úberwuchs korrigiert
    </option>
    <option value="Lose Hornteile entfernt">
        Lose Hornteile entfernt
    </option>

    <!-- Mortellaro -->
    <option value="Mortellaro gereinigt und behandelt">
        Mortellaro gereinigt und behandelt
    </option>

    <!-- Limax / doppelte Sohle -->
    <option value="Doppelte Sohle entfernt">
        Doppelte Sohle entfernt
    </option>

    <!-- Ballengeschw√ºr -->
    <option value="Ballengeschw√ºr versorgt">
        Ballengeschw√ºr versorgt
    </option>

    <!-- Wei√üe Linie -->
    <option value="Wei√üe-Linie-Defekt freigelegt">
        Wei√üe-Linie-Defekt freigelegt
    </option>

    <!-- Panaritium / Entz√ºndung -->
    <option value="Entz√ºndung freigelegt">
        Entz√ºndung freigelegt
    </option>

    <!-- Klauenf√§ule -->
    <option value="Faules Horn entfernt">
        Faules Horn entfernt
    </option>

    <!-- Trauma -->
    <option value="Verletzung versorgt">
        Verletzung versorgt
    </option>

    <!-- Hornspalt -->
    <option value="Hornspalt entlastet">
        Hornspalt entlastet
    </option>

    <!-- Block / Verband -->
    <option value="Entlastungsblock gesetzt">
        Entlastungsblock gesetzt
    </option>
    <option value="Verband angelegt">
        Verband angelegt
    </option>

    <!-- Kontrolle -->
    <option value="Nachkontrolle empfohlen">
        Nachkontrolle empfohlen
    </option>
</select>


<textarea id="treatActions"
          placeholder="Ma√ünahmen eingeben oder erg√§nzen‚Ä¶"
          rows="2"></textarea>
        <div class="row">
            <div>
                <label>Block gesetzt?</label>
                <select id="treatBlock">
                    <option value="">Nein / nicht relevant</option>
                    <option value="ja">Ja</option>
                </select>
            </div>
            <div>
                <label>Verband?</label>
                <select id="treatBandage">
                    <option value="">Nein</option>
                    <option value="ja">Ja</option>
                </select>
            </div>
        </div>

<label>Produkt / Medikament</label>

<select id="treatProductPreset"
        onchange="applyProductPreset()"
        style="margin-bottom:6px;">
    <option value="">‚Äì Produkt ausw√§hlen ‚Äì</option>
    <option value="Blue Spray">Blue Spray</option>
    <option value="Novoderm Salbe">Novoderm Salbe</option>
    <option value="Schwarze Salbe">Schwarze Salbe</option>
    <option value="Intra Hoof-fit Gel">Intra Hoof-fit Gel</option>
    <option value="Mortellaro-Salbe">Mortellaro-Salbe</option>
    <option value="Kupfersulfat-Spray">Kupfersulfat-Spray</option>
    <option value="Jodspray">Jodspray</option>
    <option value="Ohne Medikament">Ohne Medikament</option>
</select>

<input id="treatProduct"
       placeholder="Produkt wird √ºbernommen oder manuell eingeben">
        <label>N√§chste Kontrolle / Termin</label>
        <input id="treatNextCheck" placeholder="z.B. in 2 Wochen, 07.12.2025">

        <label>Zus√§tzliche Notizen zur Behandlung</label>
        <textarea id="treatNotes" placeholder="z.B. stark entz√ºndet, vorsichtig beschneiden"></textarea>

        <button onclick="saveTreatment()">üíæ Behandlung speichern</button>
        <div id="treatMessage" class="msg"></div>
    </section>

    <!-- 3. HISTORIE -->
    <section class="card">
        <h2>3. Kuh-Historie anzeigen</h2>
        <label>Kuh Nummer f√ºr Historie</label>
        <select id="historyCowSelect">
            <option value="">Kuh ausw√§hlen‚Ä¶</option>
        </select>

        <button class="secondary" onclick="showHistory()">üìú Historie anzeigen</button>
        <div id="historyArea"></div>
    </section>

    <!-- 4. ALLE K√úHE -->
    <section class="card">
        <h2>4. Alle K√ºhe anzeigen</h2>
        <button class="secondary" onclick="showAllCows()">üìã Liste aller K√ºhe</button>
        <div id="allCowsArea" style="margin-top:8px;"></div>
    </section>

    <!-- 5. TAGES√úBERSICHT / PDF-BERICHT -->
    <section class="card" id="reportCard">
        <h2>5. Tages√ºbersicht / PDF-Bericht</h2>
        <label>Datum der Behandlungen (TT.MM.JJJJ)</label>
        <input id="reportDate" placeholder="z.B. 07.12.2025">

        <button onclick="renderDailyReport()">Tagesbericht anzeigen</button>
        <button class="secondary" onclick="window.print()">F√ºr PDF / Druck vorbereiten</button>

        <p class="info">
            Tipp: Datum eingeben ‚Äì Bericht anzeigen ‚Äì dann im Browser ‚ÄûAls PDF speichern‚Äú w√§hlen, um einen Bericht f√ºr den Betrieb zu erstellen.
        </p>

        <div id="reportArea"></div>
    </section>

    <!-- DATENVERWALTUNG + BACKUP -->
    <section class="card">
        <h2>‚ö† Datenverwaltung</h2>
        <p class="info">
            Alle Daten werden lokal im Browser gespeichert (localStorage). Kein Internet, kein Server.
            <br>Nur auf diesem Ger√§t sichtbar.
        </p>
        <button class="danger" onclick="clearAll()">Alles l√∂schen (alle K√ºhe &amp; Behandlungen)</button>
        <div id="clearMessage" class="msg"></div>

        <h3 style="margin-top:16px;">Backup</h3>
        <p class="info">
            Backup-Datei aller K√ºhe &amp; Behandlungen erstellen und sp√§ter wieder importieren (z.B. beim Handywechsel).
        </p>
        <button onclick="exportBackup()">Backup exportieren</button>

        <p class="info" style="margin-top:10px;">
            Backup-Datei importieren (√ºberschreibt aktuelle Daten):
        </p>
        <input type="file" id="backupFile" accept="application/json" onchange="importBackup(event)">
        <div id="backupMessage" class="msg"></div>
    </section>

</main>

<script>
    // ---------- ONLINE / OFFLINE STATUS ----------
    function updateOnlineStatus() {
        var el = document.getElementById("connectionStatus");
        if (!el) return;
        if (navigator.onLine) {
            el.textContent = "üü¢ Online-Modus (bereit f√ºr Cloud-Synchronisation)";
            el.style.color = "#bbf7d0";
        } else {
            el.textContent = "üî¥ Offline-Modus (lokale Datenspeicherung)";
            el.style.color = "#fecaca";
        }
    }
    window.addEventListener("load", updateOnlineStatus);
    window.addEventListener("online", updateOnlineStatus);
    window.addEventListener("offline", updateOnlineStatus);

    // ---------- DATENSTRUKTUR ----------
    let cows = {}; // { "245": { farm, geburt, lahm, notizen, behandlungen: [...] } }

    function loadData() {
        try {
            const raw = localStorage.getItem("bakhtovar_klauen_data");
            cows = raw ? JSON.parse(raw) || {} : {};
        } catch (e) {
            cows = {};
        }
    }

    function saveData() {
        localStorage.setItem("bakhtovar_klauen_data", JSON.stringify(cows));
        updateCowSelects();
    }

    function updateCowSelects() {
        const treatSel = document.getElementById("treatCowSelect");
        const histSel = document.getElementById("historyCowSelect");

        function fillSelect(sel) {
            const current = sel.value;
            sel.innerHTML = "";
            const opt0 = document.createElement("option");
            opt0.value = "";
            opt0.textContent = "-- Kuh ausw√§hlen --";
            sel.appendChild(opt0);

            const numbers = Object.keys(cows).sort();
            numbers.forEach(num => {
                const o = document.createElement("option");
                o.value = num;
                const c = cows[num];
                const hof = c.farm ? " (" + c.farm + ")" : "";
                o.textContent = num + hof;
                sel.appendChild(o);
            });

            if (current && cows[current]) sel.value = current;
        }

        fillSelect(treatSel);
        fillSelect(histSel);
    }

    // ---------- KUH SPEICHERN ----------
    function saveCow() {
        const num   = document.getElementById("cowNumber").value.trim();
        const farm  = document.getElementById("farmName").value.trim();
        const geb   = document.getElementById("birthDate").value.trim();
        const lahm  = document.getElementById("lameStatus").value.trim();
        const notes = document.getElementById("cowNotes").value.trim();
        const msg   = document.getElementById("cowMessage");

        if (!num) {
            msg.textContent = "Bitte Kuh-Nummer eingeben.";
            msg.className = "msg err";
            return;
        }

        if (!cows[num]) {
            cows[num] = {
                farm: farm,
                geburt: geb,
                lahm: lahm,
                notizen: notes,
                behandlungen: []
            };
            msg.textContent = "‚úÖ Neue Kuh gespeichert: " + num;
        } else {
            cows[num].farm    = farm  || cows[num].farm;
            cows[num].geburt  = geb   || cows[num].geburt;
            cows[num].lahm    = lahm  || cows[num].lahm;
            cows[num].notizen = notes || cows[num].notizen;
            msg.textContent   = "‚úÖ Kuh aktualisiert: " + num;
        }

        msg.className = "msg ok";
        saveData();
    }

    // ---------- BEHANDLUNG SPEICHERN ----------
    function saveTreatment() {
        const num       = document.getElementById("treatCowSelect").value;
        const date      = document.getElementById("treatDate").value.trim();
        const leg       = document.getElementById("treatLeg").value;
        const problem   = document.getElementById("treatProblem").value.trim();
        const actions   = document.getElementById("treatActions").value.trim();
        const block     = document.getElementById("treatBlock").value;
        const bandage   = document.getElementById("treatBandage").value;
        const product   = document.getElementById("treatProduct").value.trim();
        const nextCheck = document.getElementById("treatNextCheck").value.trim();
        const notes     = document.getElementById("treatNotes").value.trim();
        const msg       = document.getElementById("treatMessage");

        if (!num) {
            msg.textContent = "Bitte zuerst eine Kuh ausw√§hlen.";
            msg.className = "msg err";
            return;
        }
        if (!cows[num]) {
            msg.textContent = "Diese Kuh existiert nicht mehr.";
            msg.className = "msg err";
            return;
        }

        const today = new Date();
        const defaultDate = today.toLocaleDateString("de-DE");
        const finalDate = date || defaultDate;

        const entry = {
            datum: finalDate,
            klaue: leg,
            problem: problem,
            aktion: actions,
            block: block,
            verband: bandage,
            produkt: product,
            naechsteKontrolle: nextCheck,
            notizen: notes
        };

        cows[num].behandlungen.push(entry);
        msg.textContent = "‚úÖ Behandlung gespeichert f√ºr Kuh " + num;
        msg.className = "msg ok";

        saveData();
    }

    // ---------- HISTORIE ----------
    function showHistory() {
        const num  = document.getElementById("historyCowSelect").value;
        const area = document.getElementById("historyArea");
        area.innerHTML = "";

        if (!num || !cows[num]) {
            area.innerHTML = "<p class='msg err'>Kuh nicht gefunden.</p>";
            return;
        }
        const c = cows[num];

        let html = "";
        html += "<p><span class='badge'>Kuh</span> <strong>" + num + "</strong>";
        if (c.farm) html += " ‚Äì " + c.farm;
        html += "</p>";
        if (c.geburt) html += "<p>üìÖ Geburt: " + c.geburt + "</p>";
        if (c.lahm)   html += "<p>‚ö† Lahm: " + c.lahm + "</p>";
        if (c.notizen) html += "<p>üìù Notizen: " + c.notizen + "</p>";

        if (!c.behandlungen || c.behandlungen.length === 0) {
            html += "<p class='info'>Keine Behandlungen eingetragen.</p>";
        } else {
            html += "<h3>Behandlungen:</h3>";
            html += "<table><thead><tr>" +
                "<th>Datum</th><th>Klauen</th><th>Problem</th><th>Aktion</th>" +
                "<th>Block</th><th>Verband</th><th>Produkt</th><th>N√§chste Kontrolle</th>" +
                "</tr></thead><tbody>";
            c.behandlungen.forEach(b => {
                html += "<tr>" +
                    "<td>" + (b.datum || "") + "</td>" +
                    "<td>" + (b.klaue || "") + "</td>" +
                    "<td>" + (b.problem || "") + "</td>" +
                    "<td>" + (b.aktion || "") + "</td>" +
                    "<td>" + (b.block === "ja" ? "‚úÖ" : "") + "</td>" +
                    "<td>" + (b.verband === "ja" ? "‚úÖ" : "") + "</td>" +
                    "<td>" + (b.produkt || "") + "</td>" +
                    "<td>" + (b.naechsteKontrolle || "") + "</td>" +
                    "</tr>";
            });
            html += "</tbody></table>";
        }

        area.innerHTML = html;
    }

    // ---------- ALLE K√úHE ----------
    function showAllCows() {
        const area = document.getElementById("allCowsArea");
        area.innerHTML = "";

        const numbers = Object.keys(cows).sort();
        if (numbers.length === 0) {
            area.innerHTML = "<p class='info'>Noch keine K√ºhe gespeichert.</p>";
            return;
        }

        let html = "<table><thead><tr>" +
            "<th>Kuh</th><th>Hof</th><th>Geburt</th><th>Lahm</th><th>Behandlungen</th>" +
            "</tr></thead><tbody>";

        numbers.forEach(num => {
            const c = cows[num];
            html += "<tr>" +
                "<td>" + num + "</td>" +
                "<td>" + (c.farm || "") + "</td>" +
                "<td>" + (c.geburt || "") + "</td>" +
                "<td>" + (c.lahm || "") + "</td>" +
                "<td>" + ((c.behandlungen && c.behandlungen.length) ? c.behandlungen.length : 0) + "</td>" +
                "</tr>";
        });

        html += "</tbody></table>";
        area.innerHTML = html;
    }

    // ---------- ALLES L√ñSCH–ï–ù ----------
    function clearAll() {
        if (!confirm("Wirklich ALLE Daten l√∂schen?")) return;

        cows = {};
        localStorage.removeItem("bakhtovar_klauen_data");

        document.getElementById("historyArea").innerHTML = "";
        document.getElementById("allCowsArea").innerHTML = "";
        document.getElementById("clearMessage").innerText =
            "Alle Daten gel√∂scht (inkl. Speicher).";
        document.getElementById("clearMessage").className = "msg ok";

        updateCowSelects();
    }

    // ---------- BACKUP ----------
    function exportBackup() {
        try {
            var raw = localStorage.getItem("bakhtovar_klauen_data");
            if (!raw) {
                alert("Es sind keine Daten zum Sichern vorhanden.");
                return;
            }

            var backup = {
                exportedAt: new Date().toISOString(),
                key: "bakhtovar_klauen_data",
                data: raw
            };

            var json = JSON.stringify(backup, null, 2);
            var blob = new Blob([json], { type: "application/json" });
            var url = URL.createObjectURL(blob);

            var a = document.createElement("a");
            var heute = new Date().toISOString().slice(0, 10);
            a.href = url;
            a.download = "klauenpflege-backup-" + heute + ".json";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            document.getElementById("backupMessage").innerText =
                "Backup wurde heruntergeladen.";
            document.getElementById("backupMessage").className = "msg ok";
        } catch (e) {
            console.error(e);
            alert("Fehler beim Backup-Export: " + e.message);
        }
    }

    function importBackup(event) {
        var file = event.target.files[0];
        if (!file) return;

        if (!confirm("Achtung: Vorhandene Daten werden √ºberschrieben. Fortfahren?")) {
            event.target.value = "";
            return;
        }

        var reader = new FileReader();
        reader.onload = function (e) {
            try {
                var text = e.target.result;
                var backup = JSON.parse(text);

                var key = backup.key || "bakhtovar_klauen_data";
                var rawData = backup.data || null;

                if (!rawData) {
                    alert("Backup-Datei enth√§lt keine Daten.");
                    event.target.value = "";
                    return;
                }

                localStorage.setItem(key, rawData);

                document.getElementById("backupMessage").innerText =
                    "Backup erfolgreich importiert. Seite wird neu geladen.";
                document.getElementById("backupMessage").className = "msg ok";

                event.target.value = "";
                location.reload();
            } catch (err) {
                console.error(err);
                alert("Fehler beim Backup-Import: " + err.message);
                event.target.value = "";
            }
        };
        reader.readAsText(file);
    }

  // ---------- TAGESBERICHT ----------
function renderDailyReport() {
    var date = document.getElementById("reportDate").value.trim();
    var area = document.getElementById("reportArea");

    if (!date) {
        area.innerHTML = "<p class='info'>Bitte ein Datum im Format TT.MM.JJJJ eingeben.</p>";
        return;
    }

    var rows = [];

    // —á–µ—Ä–µ–∑ –≤—Å–µ K√ºhe –∏ Behandlungen
    Object.keys(cows).forEach(function (num) {
        var c = cows[num];
        if (!c.behandlungen || !c.behandlungen.length) return;

        c.behandlungen.forEach(function (b) {
            if (b.datum === date) {
                rows.push({
                    kuh: num,
                    farm: c.farm || "",
                    klaue: b.klaue || "",
                    problem: b.problem || "",
                    aktion: b.aktion || "",
                    block: (b.block === "ja") ? "Ja" : "",
                    verband: (b.verband === "ja") ? "Ja" : "",
                    produkt: b.produkt || "",
                    naechste: b.naechsteKontrolle || ""
                });
            }
        });
    });

    if (!rows.length) {
        area.innerHTML = "<p class='info'>Keine Behandlungen f√ºr dieses Datum gefunden.</p>";
        return;
    }

    // Betrieb –∏–∑ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏, –≥–¥–µ –µ—Å—Ç—å Hof
    var betriebName = "";
    rows.forEach(function (r) {
        if (!betriebName && r.farm) {
            betriebName = r.farm;
        }
    });

    var ort = "Sande / Niedersachsen";

    var html = "";
    html += "<div class='report-container'>";

    // —à–∞–ø–∫–∞
    html += "  <div class='report-header'>";
    html += "    <div class='report-title-row'>";
    html += "      <div>";
    html += "        <span class='report-header-icon'>üêÑ</span>";
    html += "        <span class='report-title-main'>Valiev Klauenpflege Service</span>";
    html += "      </div>";
    html += "      <div class='report-title-date'>Tagesbericht Klauenpflege ‚Äì " + date + "</div>";
    html += "    </div>";
    html += "    <div class='report-subtitle'>Digitale Klauenpflege-Software f√ºr Dokumentation, Kontrolle und Auswertung</div>";
    html += "  </div>";

    // —Ç–æ–Ω–∫–∞—è —Å–µ—Ä–∞—è –ª–∏–Ω–∏—è –ø–æ–¥ —à–∞–ø–∫–æ–π
    html += "  <div class='report-divider'></div>";

    // –±–ª–æ–∫ —Å –∞–¥—Ä–µ—Å–æ–º –≤ —Ç—Ä–∏ —Å—Ç—Ä–æ–∫–∏, –∫–∞–∫ –≤ —Å—Ç–∞—Ä–æ–º –æ—Ç—á—ë—Ç–µ
html += "  <div class='report-meta'>";
if (betriebName) {
    html += "    <div><strong>Betrieb:</strong> " + betriebName + "</div>";
}
html += "    <div><strong>Ort:</strong> " + ort + "</div>";
html += "    <div><strong>Dienstleister:</strong> Valiev Klauenpflege Service</div>";
html += "  </div>";

    // —Ç–∞–±–ª–∏—Ü–∞
    html += "  <table class='report-table'>";
    html += "    <thead><tr>" +
        "<th>Kuhnr.</th>" +
        "<th>Betrieb / Hof</th>" +
        "<th>Klaue</th>" +
        "<th>Problem / Diagnose</th>" +
        "<th>Ma√ünahmen</th>" +
        "<th>Block</th>" +
        "<th>Verband</th>" +
        "<th>Produkt</th>" +
        "<th>N√§chste Kontrolle</th>" +
        "</tr></thead><tbody>";

    rows.forEach(function (r) {
        html += "<tr>" +
            "<td>" + r.kuh + "</td>" +
            "<td>" + (r.farm || "-") + "</td>" +
            "<td>" + (r.klaue || "-") + "</td>" +
            "<td>" + (r.problem || "-") + "</td>" +
            "<td>" + (r.aktion || "-") + "</td>" +
            "<td>" + (r.block || "-") + "</td>" +
            "<td>" + (r.verband || "-") + "</td>" +
            "<td>" + (r.produkt || "-") + "</td>" +
            "<td>" + (r.naechste || "-") + "</td>" +
            "</tr>";
    });

    html += "    </tbody></table>";

    // –ø–æ–¥–≤–∞–ª
    html += "  <div class='report-footer'>";
    html += "    <p><strong>Hinweis:</strong> Bericht kann digital als PDF gespeichert oder ausgedruckt dem Betrieb zur Verf√ºgung gestellt werden.</p>";
    html += "    <p><strong>Klauenpfleger:</strong> B. Valiev, Valiev Klauenpflege Service</p>";
    html += "  </div>";

    html += "</div>";

    area.innerHTML = html;
}

// ---------- –ü–†–û–í–ï–†–ö–ê: –ø—Ä–æ—Å—Ç—ã–µ –ø—Ä–µ—Å–µ—Ç—ã ----------

// 1) –ë–æ–ª–µ–∑–Ω—å -> –ø—Ä–æ—Å—Ç–æ –∑–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç –≤ Problem
function applyProblemPreset() {
    const sel  = document.getElementById("treatProblemPreset");
    const prob = document.getElementById("treatProblem");

    if (!sel || !prob) {
        alert("treatProblemPreset –∏–ª–∏ treatProblem –Ω–µ –Ω–∞–π–¥–µ–Ω");
        return;
    }

    prob.value = sel.value || "";
    if (sel.value) {
        alert("ProblemPreset –≤—ã–±—Ä–∞–Ω: " + sel.value);
    }
}

// 2) Ma√ünahmen -> –ø—Ä–æ—Å—Ç–æ –∑–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç –≤ –ø–æ–ª–µ
function applyActionsPreset() {
    const sel   = document.getElementById("treatActionsPreset");
    const field = document.getElementById("treatActions");

    if (!sel || !field) {
        alert("treatActionsPreset –∏–ª–∏ treatActions –Ω–µ –Ω–∞–π–¥–µ–Ω");
        return;
    }

    field.value = sel.value || "";
    if (sel.value) {
        alert("Ma√ünahme: " + sel.value);
    }
}

// 3) Produkt -> –ø—Ä–æ—Å—Ç–æ –∑–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç –≤ –ø–æ–ª–µ
function applyProductPreset() {
    const sel   = document.getElementById("treatProductPreset");
    const field = document.getElementById("treatProduct");

    if (!sel || !field) {
        alert("treatProductPreset –∏–ª–∏ treatProduct –Ω–µ –Ω–∞–π–¥–µ–Ω");
        return;
    }

    field.value = sel.value || "";
    if (sel.value) {
        alert("Produkt: " + sel.value);
    }
}
// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker –¥–ª—è PWA
if ("serviceWorker" in navigator) {          // –í–ê–ñ–ù–û: W ‚Äì –±–æ–ª—å—à–∞—è
    window.addEventListener("load", function () {
        navigator.serviceWorker
            .register("./sw.js")
            .catch(function (err) {
                console.error("Service Worker Registrierung fehlgeschlagen:", err);
            });
    });
}
  // ---------- INIT ----------
    window.addEventListener("load", function () {
        loadData();
        updateCowSelects();
    });
</script>

</body>
</html>